import * as dotenv from "dotenv";
import { Connection, PublicKey } from "@solana/web3.js";
import { 
  initializeRPCConfig, 
  getRPCConfig, 
  getActiveConnection, 
  getActiveCluster,
  isRPCConfigInitialized,
  type SolanaCluster 
} from "./config/rpcConfig";

dotenv.config();

// Initialize RPC configuration at module load
// This must happen before any other imports that use the config
if (!isRPCConfigInitialized()) {
  initializeRPCConfig(process.env.HELIUS_API_KEY || '');
}

export const config = {
  // DEPRECATED: Use getRPCConfig().getRPCEndpoint() instead
  // Kept for backward compatibility during migration
  get rpcEndpoint(): string {
    console.warn('[DEPRECATED] config.rpcEndpoint is deprecated. Use getRPCConfig().getRPCEndpoint() instead.');
    return getRPCConfig().getRPCEndpoint();
  },
  treasuryPrivateKey: process.env.TREASURY_PRIVATE_KEY || "",
  adminPrivateKey:
    process.env.ADMIN_PRIVATE_KEY || process.env.TREASURY_PRIVATE_KEY || "",
  feeWallet: process.env.FEE_WALLET
    ? new PublicKey(process.env.FEE_WALLET)
    : undefined,
  customTokenMint: process.env.CUSTOM_TOKEN_MINT
    ? new PublicKey(process.env.CUSTOM_TOKEN_MINT)
    : undefined,
  nftCollectionAddress: process.env.NFT_COLLECTION_ADDRESS
    ? new PublicKey(process.env.NFT_COLLECTION_ADDRESS)
    : undefined,
  claimFeeSOL: 0.01,
  claimFeeUSD: 2.0,
  supabaseUrl: process.env.SUPABASE_URL || "",
  supabaseServiceRoleKey: process.env.SUPABASE_SERVICE_ROLE_KEY || "",
  nftThreshold: parseInt(process.env.NFT_THRESHOLD || "20"),
  syncIntervalHours: parseInt(process.env.SYNC_INTERVAL_HOURS || "24"),
  vestingDurationDays: parseInt(process.env.VESTING_DURATION_DAYS || "365"),
  vestingCliffDays: parseInt(process.env.VESTING_CLIFF_DAYS || "30"),
  baseAllocationAmount: parseInt(
    process.env.BASE_ALLOCATION_AMOUNT || "1000000000000"
  ),
  heliusApiKey: process.env.HELIUS_API_KEY || "",
  gracePeriodDays: parseInt(process.env.GRACE_PERIOD_DAYS || "30"),
  masterPassword:
    process.env.MASTER_PASSWORD || "default_dev_password_do_not_use_prod",
  // Minimum payout threshold in lamports (10,000 lamports = 0.00001 SOL)
  // Allocations below this amount will be set to 0 and tracked as unallocated remainder
  minPayoutLamports: parseInt(
    process.env.MIN_PAYOUT_LAMPORTS || "10000"
  ),
}; // 1M tokens with 9 decimals

/**
 * Get a Connection instance for the active network
 * Uses the centralized RPC configuration
 */
export const getConnection = (): Connection => {
  return getActiveConnection();
};

/**
 * Get the current Solana network/cluster
 * Uses the centralized RPC configuration
 */
export const getNetwork = (): SolanaCluster => {
  return getActiveCluster();
};

// Re-export RPC config functions for convenience
export {
  initializeRPCConfig,
  getRPCConfig,
  getActiveConnection,
  getActiveCluster,
  isRPCConfigInitialized,
} from "./config/rpcConfig";
